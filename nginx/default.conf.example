upstream mainweb_app {
    server mainweb_app:3000;
}

upstream mcpweb_app {
    server mcpweb_app:3000;
}

upstream apiservice_srv {
    server apiservice_srv:8080;
}

log_format detailed '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" '
                    'rt=$request_time uct="$upstream_connect_time" '
                    'uht="$upstream_header_time" urt="$upstream_response_time"';

# JSON log format for easier parsing
log_format json_combined escape=json
  '{'
    '"time_local":"$time_local",'
    '"remote_addr":"$remote_addr",'
    '"remote_user":"$remote_user",'
    '"request":"$request",'
    '"status": "$status",'
    '"body_bytes_sent":"$body_bytes_sent",'
    '"request_time":"$request_time",'
    '"http_referrer":"$http_referer",'
    '"http_user_agent":"$http_user_agent"'
  '}';


# MAINWEB SERVICE
server {
    listen 80;
    server_name main.yourdomain.com;  # Replace with your actual Main site domain
    
    # Logging
    access_log /var/log/nginx/mainweb-access.log detailed;
    error_log /var/log/nginx/mainweb-error.log warn;
    
    # File upload size
    client_max_body_size 100M;
    
    # Serve uploaded files directly - MUST come before the catch-all
    location /uploads/ {
        alias /usr/share/nginx/html/uploads/;
        try_files $uri =404;
        
        # Cache settings
        expires 30d;
        add_header Cache-Control "public, immutable";
        
        # Security - only allow specific file types
        location ~ \.(jpg|jpeg|png|gif|pdf|doc|docx|xls|xlsx)$ {
            # Allowed
        }
        
        location ~ \. {
            deny all;
            return 404;
        }
    }
    
    # API routes to the Go service - be specific about API paths
    location /api/mcp/ {
        proxy_pass http://apiservice_srv;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    location /auth/ {
        proxy_pass http://apiservice_srv;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    location /api/manager/ {
        proxy_pass http://apiservice_srv;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Next.js App Router API routes
    location /api/ {
        # Check if it should go to Next.js or the Go service
        proxy_pass http://mainweb_app;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
    
    # Next.js specific static files
    location /_next/static/ {
        proxy_pass http://mainweb_app;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    location /_next/image/ {
        proxy_pass http://mainweb_app;
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
    }
    
    # WebSocket support for HMR in development
    location /_next/webpack-hmr {
        proxy_pass http://mainweb_app;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    # Health check
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
    
    # IMPORTANT: This must be last - catch all for Next.js pages
    location / {
        # Don't try to serve files, just proxy everything to Next.js
        proxy_pass http://mainweb_app;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Important: Don't use try_files here as it will break dynamic routes
        # Let Next.js handle all routing
    }
}

# MCP website configuration
server {
    listen 80;
    server_name mcp.yourdomain.com;  # Replace with your actual MCP domain
    
    # Logging
    access_log /var/log/nginx/mcpweb-access.log detailed;
    error_log /var/log/nginx/mcpweb-error.log warn;

    # File upload size
    client_max_body_size 100M;
    
    # Handle exact /api/mcp
    location = /api/mcp {
        proxy_pass http://mcpweb_app;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-API-KEY $http_x_api_key;
        proxy_redirect off;
        
        # MCP specific headers
        proxy_set_header Accept "application/json, text/event-stream";
        proxy_set_header Content-Type "application/json";
        
        # Streaming support
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }
    
    # Handle MCP paths with trailing parts
    location ^~ /api/mcp/ {
        proxy_pass http://mcpweb_app;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-API-KEY $http_x_api_key;
        proxy_redirect off;
        
        # MCP specific headers
        proxy_set_header Accept "application/json, text/event-stream";
        proxy_set_header Content-Type "application/json";
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    # Everything else goes to mcpweb_app
    location / {
        proxy_pass http://mcpweb_app;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

}