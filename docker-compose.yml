services:
  apiserver_srv:
    image: loginwebinar/apiserver:latest
    container_name: apiserver_srv
    restart: unless-stopped
    volumes:
      - ./keys:/app/keys  # Mount the local 'keys' directory into the container
    expose:
      - "8080"  # Expose the application port
    environment:
      # Optional: You can override or add environment variables here
      NEVER_CHANGE_AFTER_INSTALLATION_32_BYTE_KEY: ${NEVER_CHANGE_AFTER_INSTALLATION_32_BYTE_KEY}
      BUNNY_FONT_API: ${BUNNY_FONT_API}
      GOOGLE_FONT_API: ${GOOGLE_FONT_API}
      POSTGRES_DB_HOST: ${POSTGRES_DB_HOST}
      POSTGRES_DB_PORT: ${POSTGRES_DB_PORT}
      POSTGRES_DB_SCHEMA: ${POSTGRES_DB_SCHEMA}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      SWAGGER_KEY: ${SWAGGER_KEY}
      SWAGGER_USERNAME: ${SWAGGER_USERNAME}
      SWAGGER_PASSWORD: ${SWAGGER_PASSWORD}
      HEARTBEAT_WSURL: ${HEARTBEAT_WSURL}
      API_HTTP_PORT: ${API_HTTP_PORT}
      SITE_URL: ${SITE_URL}
    extra_hosts:
      - "postgres.host:host-gateway"
  heartbeat_srv:
    image: loginwebinar/heartbeat:latest
    container_name: heartbeat_srv
    restart: unless-stopped
    volumes:
      - ./keys:/app/keys
    expose:
      - "8082"
    environment:
      POSTGRES_DB_HOST: ${POSTGRES_DB_HOST}
      POSTGRES_DB_PORT: ${POSTGRES_DB_PORT}
      POSTGRES_DB_SCHEMA: ${POSTGRES_DB_SCHEMA}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      HEARTBEAT_PORT: ${HEARTBEAT_PORT}
    extra_hosts:
      - "postgres.host:host-gateway"
  mainweb_app:
    image: loginwebinar/mainwebapp:latest
    container_name: mainweb_app
    restart: unless-stopped
    expose:
      - "3000"
    volumes:
      - /srv/loginwebinar-standard/uploads:/usr/src/app/public/uploads
    environment:
      NODE_ENV: production
      NODE_OPTIONS: "--max-old-space-size=4096"
      SITE_URL: ${SITE_URL}
      MAIN_API_URL: ${MAIN_API_URL}
      MANAGER_COOKIE_PREFIX: ${MANAGER_COOKIE_PREFIX}
      VIEWER_COOKIE_PREFIX: ${VIEWER_COOKIE_PREFIX}
      PUBLIC_PEM: ${PUBLIC_PEM}
      VERSION: "1.0"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
  mcpweb_app:
    image: loginwebinar/mcpwebapp:latest
    container_name: mcpweb_app
    restart: unless-stopped
    expose:
      - "3000"
    environment:
      NODE_ENV: production
      NODE_OPTIONS: "--max-old-space-size=4096"
      SITE_URL: ${SITE_URL}
      MAIN_API_URL: ${MAIN_API_URL}
      PUBLIC_PEM: ${PUBLIC_PEM}
      VERSION: "1.0"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /srv/loginwebinar-standard/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - /srv/loginwebinar-standard/uploads:/usr/share/nginx/html/uploads:ro
      - /srv/loginwebinar-standard/nginx/logs:/var/log/nginx
      - /srv/loginwebinar-standard/ssl:/etc/nginx/ssl:ro
    depends_on:
      - mainweb_app
      - mcpweb_app
      - apiserver_srv
      - heartbeat_srv
    restart: unless-stopped
